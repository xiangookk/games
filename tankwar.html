<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <title>坦克大战</title>
<style type="text/css">
    body{
	    text-align:center;
	    background-color:#1B272C;
        font-family:LiSu,KaiTi;
        font-size:18px;
        padding-top:10px;
        color:#fff;    
	    }
    #frame{
        box-shadow:0px 0px 15px rgba(222, 226, 237, 0.84);
        border-radius:6px;
        -o-box-shadow:0px 0px 15px rgba(222, 226, 237, 0.84);
        -o-border-radius:6px;
        /*-moz-transition:-moz-transform 2s; 
        -webkit-transition:-webkit-transform 2s;
        -o-transition:-o-transform 2s;*/

	    padding:2px;
        background-color:#ccc;
        margin-left:auto;
	    margin-right:auto;
	    width:339px;
	    height:374px;
	    border:outset 2px #CCCCCC;
        position:relative;
	    }
    #frametitle{
        font-weight:600;
	    width:100%;
	    height:20px;
	    background-color:#CCCCCC;
        color:black;
	    }
    #framebody {
        height:352px;
        background-color:#1B272C;
    }
    #bodyleft {
        height:100%;
        float:left;
        border-right:solid 1px #CCCCCC;
        margin-right:-1px;
        position:relative;
    }
    #bodyright {
        width:80px;
        height:100%;
        float:right;
        border:solid 0px green;
    }
    #main {
        border-top:solid 1px #CCCCCC ;
        width:100%;
        height:100%;
        background-color:#000;
    }
   
   #btnSetting,#btnControl,#btnSave,#btnClose {
        width:60px;
        height:25px;
        font-size:16px;
        font-weight:bold;
        background-color:#1B272C;
        border:solid 1px #CCCCCC;
        color:#fff;
    }
    #btnSetting:hover,#btnControl:hover,#btnSave:hover,#btnClose:hover {
        background-color:rgba(204, 204, 204, 0.34);
        cursor:pointer;
    }
    #msg {
         position:absolute;
         width:40px;
         height:7px;
         border-radius:15px;
         border:solid 2px #ccc;
         background-color:#010424;
         padding-top:20px;
         font-size:35px;
         font-family:KaiTi,LiSu; 
         font-weight:bold;
         color:red;
         display:none;
    }  
    #divSetting {
         position:absolute;
         width:330px;
         height:160px;
         border-radius:10px;
         border:solid 2px #ccc;
         background-color:#010424;
         padding-top:20px;
         text-align: center;
         font-size:20px;
         font-family:KaiTi,LiSu; 
         font-weight:bold;
         color:white;
         display:none;
    }
     #bossHP {
         position:absolute;
         width:120px;
         height:60px;
         left:-125px;
         top:0px;
         border-radius:5px;
         border:solid 1px #ccc;
         background-color:#010424;
         padding-top:10px;
         text-align: center;
         font-size:18px;
         font-family:KaiTi,LiSu; 
         font-weight:bold;
         color:white;
         display:none;
    }
</style>
</head>
<body>
<div style="height:42px;width:400px; margin-left:auto;margin-right:auto; ">
   <div style="height:30px;width:350px;padding-top:10px;float:left; ">Z键或PageDown键：发射&nbsp;&nbsp; &nbsp;   声音控制：</div>
   <canvas id="myCanvas" width="50" height="40" style="cursor:pointer; float:left; "  title="点击切换">您的浏览器不支持HTML5新特性</canvas>
</div>
<div id="frame">
  <div id="frametitle">坦克大战</div>
  <div id="framebody">
      <div id="bodyleft">
        
        <div id="main">
        </div>
      </div>
      <div id="bodyright">    
          <div id="score">得分：<br /><span>0</span></div>
          <div id="level">级别：<br /><span>1</span></div>    
          <div id="menu">
            <br />
            <input type="button" id="btnSetting" value="设置" />
            <br /><br />
            <input type="button" id="btnControl" value="开始" />
          </div>   
      </div>    
  </div>
  <div id="divSetting">
      <ul style="list-style:none;padding:0px;margin:0px">
          <li>
              单格边长：<input type="range" id="boxWidth" min="10" max="35" style="margin-bottom:-4px"/>
              <input type='text' value='' style='font-size:14px;width:20px;height:14px' readonly/>          
          </li>
          <li>
              主窗口宽：<input type="range" id="mainWidth" min="16" max="30" style="margin-bottom:-4px"/>
              <input type='text' value='' style='font-size:14px;width:20px;height:14px' readonly/>     
          </li>
          <li>
              主窗口高：<input type="range" id="mainHeight" min="16" max="30" style="margin-bottom:-4px"/>
              <input type='text' value='' style='font-size:14px;width:20px;height:14px' readonly/>
          </li>
          <li title="游戏开始前才能设置">
              设置级别：<input type="range" id="setLevel" min="1" max="10" style="margin-bottom:-4px"/>
              <input type='text' value='' style='font-size:14px;width:20px;height:14px' readonly/>
          </li>
          <li style="text-align:center">
              <br>
              <input type="button" id="btnSave" value="保 存"/>
              <input type="button" id="btnClose" value="关 闭"/>
          </li>
      </ul>
  </div>
  <div id="bossHP"></div>
  <div id="msg"></div>
</div>
<div><br /><a href="index.html">返回主页</a></div>

<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript">
    //使用HTML5的Canvas绘制喇叭
    var cxt;
    //声音开关 true/false
    var musicStatus;
    //锁定
    var locked = false;
    var audioCrash = "audio/Crash.wav";
    //绘制喇叭打开状
    var musicOpen = function () {
        cxt.beginPath();
        cxt.clearRect(0, 0, 50, 50);
        cxt.moveTo(15, 15);
        cxt.lineTo(6, 15);
        cxt.lineTo(6, 25);
        cxt.lineTo(15, 25);
        cxt.lineTo(15, 15);
        cxt.lineTo(25, 8);
        cxt.lineTo(25, 32);
        cxt.lineTo(15, 25);
        cxt.stroke();
        cxt.moveTo(30, 15);
        cxt.arc(16, 20, 15, -0.2, 0.2, false);
        cxt.stroke();
        cxt.moveTo(35, 12);
        cxt.arc(22, 20, 15, -0.5, 0.5, false);
        cxt.stroke();
        cxt.moveTo(39, 10);
        cxt.arc(28, 20, 15, -0.8, 0.8, false);
        cxt.stroke();
        musicStatus = true;
    }
    //绘制喇叭关闭状
    var musicClose = function () {
        cxt.beginPath();
        cxt.clearRect(0, 0, 50, 50);
        cxt.moveTo(15, 15);
        cxt.lineTo(6, 15);
        cxt.lineTo(6, 25);
        cxt.lineTo(15, 25);
        cxt.lineTo(15, 15);
        cxt.lineTo(25, 8);
        cxt.lineTo(25, 32);
        cxt.lineTo(15, 25);
        cxt.stroke();
        cxt.moveTo(6, 6);
        cxt.lineTo(35, 35);
        cxt.stroke();
        musicStatus = false;
    }
    //创建audio
    var au = document.createElement("audio");
    //播放音效
    var playAudio = function (url) {
        if (au.ended)
        { locked = false; }
        if ((!locked || url == audioCrash) && musicStatus) {
            locked = true;
            au.src = url;
            au.play();
        }
    }

       
    //单格边长（包含边框）
    var boxSide = 25;
    //背景格行数
    var bgRow = 20;
    //背景格列数
    var bgCol = 20;
    //方格背景图像
    var boxBgImg = "image/BlockBg.gif"

    //背景图像调整后的大小
    var bgImgSize;
    //背景图像一组X坐标值
    var bgImgPositionXs;
    //背景图像一组Y坐标值
    var bgImgPositionYs;
    //我方坦克背景图像X坐标值
    var meBgPositionX;
    //我方坦克背景图像Y坐标值
    var meBgPositionY;
    //敌方坦克背景图像X坐标值
    var enemyBgPositionX;
    //敌方坦克背景图像Y坐标值
    var enemyBgPositionY;

    //我方初始位置
    var mePositions;
    //敌方初始位置
    var enemyPositions;
    //当前所有敌人坦克对象
    var currentEnemyTanks;
    //当前敌人坦克Boss对象
    var currentEnemyTankBoss;
    //当前我的坦克对象
    var currentMeTank;
    //当前所有敌方子弹对象
    var currentEnemyBullets;
    //当前我方子弹对象
    var currentMeBullets;
    //方向
    var direction = [ "left","up", "right", "down"];

    //我方子弹计时器Id
    var meBulletTimerId;
    //我方子弹速度
    var meBulletSpeed = 150;
    //敌方子弹计时器Id
    var enemyBulletTimerId;
    //敌方子弹速度
    var enemyBulletSpeed = 150;
    //敌方坦克计时器Id
    var enemyTankTimerId;
    //我方坦克移动速度
    var meTankSpeed = 250;
    //敌方坦克初始移动速度
    var enemyTankInitSpeed = 800;
	//敌方坦克移动速度
    var enemyTankCurrentSpeed;
    //敌方子弹发射频率计时器
    var enemyBulletRateTimerId;
    //敌方子弹发射频率
    var enemyBulletRateSpeed = 2400;

    //敌方坦克最大数量
    var enemyTankMaxCount = 5;
    //我方子弹最大数量
    var meBulletMaxCount = 2;
    //得分
    var score = 0;
    //级别
    var level = 1;
    //每一等级分数
    var levelScore = 1000;
    //游戏是否已运行
    var runing = false;
    //是否是Boss模式
    var isBossMode = false;
    //Boss初始生命值
    var bossHP=5;
    //Boss当前生命值
    var bossCurrentHP;

    //绘制一个敌方坦克单格
    var drawEnemyTankBox = function (x, y) {
        if (x < 0 || y < 0) return;
        var i = y * bgCol + x;
        $(".box:eq(" + i + ")").css({ "width": boxSide + "px", "height": boxSide + "px", "background": "url(" + boxBgImg + ")", "background-size": bgImgSize, "backgroundPosition": enemyBgPositionX + "px " + enemyBgPositionY + "px", "border": "0px" });
        $(".box:eq(" + i + ")").attr("status", "enemyTank");
    }
    //绘制一个我方坦克单格
    var drawMeTankBox = function (x, y) {
        if (x < 0 || y < 0) return;
        var i = y * bgCol + x;
        $(".box:eq(" + i + ")").css({ "width": boxSide + "px", "height": boxSide + "px", "background": "url(" + boxBgImg + ")", "background-size": bgImgSize, "backgroundPosition": meBgPositionX + "px " + meBgPositionY + "px", "border": "0px" });
        $(".box:eq(" + i + ")").attr("status", "meTank");
    }
    //绘制一个敌方子弹单格
    var drawEnemyBulletBox = function (x, y) {
        if (x < 0 || y < 0) return;
        var i = y * bgCol + x;
        $(".box:eq(" + i + ")").css({ "width": boxSide + "px", "height": boxSide + "px", "background": "url(" + boxBgImg + ")", "background-size": bgImgSize, "backgroundPosition": enemyBgPositionX + "px " + enemyBgPositionY + "px", "border": "0px" });
        $(".box:eq(" + i + ")").attr("status", "enemyBullet");
    }
    //绘制一个我方子弹单格
    var drawMeBulletBox = function (x, y) {
        if (x < 0 || y < 0) return;
        var i = y * bgCol + x;
        $(".box:eq(" + i + ")").css({ "width": boxSide + "px", "height": boxSide + "px", "background": "url(" + boxBgImg + ")", "background-size": bgImgSize, "backgroundPosition": meBgPositionX + "px " + meBgPositionY + "px", "border": "0px" });
        $(".box:eq(" + i + ")").attr("status", "meBullet");
        // $(".box:eq(" + i + ")").html(x);
    }
    //绘制一个敌方坦克
    var drawEnemyTank = function (enemyTank,clearBoxs=[]) {
        if(clearBoxs.length==0)
        {
            for (var i = 0; i < enemyTank.positions.length; i++)
            { drawEnemyTankBox(enemyTank.positions[i][0], enemyTank.positions[i][1]); }
        }
        else
        {
            for (var i = 0; i < clearBoxs.length; i++)
           { drawEnemyTankBox(enemyTank.positions[clearBoxs[i]][0], enemyTank.positions[clearBoxs[i]][1]); }
        }       
    }
    //创建一个敌方坦克
    var createEnemyTank = function (x, y, d) {
        var _position;
        switch (d) {
            case "up":
                _position = [[x + 1, y], [x, y + 1], [x + 2, y + 1], [x + 1, y + 1], [x, y + 2], [x + 2, y + 2]];
                break;
            case "down":
                _position = [[x + 1, y + 2], [x + 2, y + 1], [x, y + 1], [x + 1, y + 1], [x + 2, y], [x, y]];
                break;
            case "left":
                _position = [[x, y + 1], [x + 1, y + 2], [x + 1, y], [x + 1, y + 1], [x + 2, y + 2], [x + 2, y]];
                break;
            case "right":
                _position = [[x + 2, y + 1], [x + 1, y], [x + 1, y + 2],  [x + 1, y + 1], [x, y],[x, y + 2]];
                break;
        }
        var enemyTank = { baseDot: [x, y], positions: _position, direction: d };
        drawEnemyTank(enemyTank);
        currentEnemyTanks.push(enemyTank);
    }
    //创建一个敌方坦克BOSS
    var createEnemyTankBoss = function (x, y) {
        var _position = [[x, y], [x + 2, y], [x + 4, y], [x + 6, y],
                         [x, y+1], [x + 1, y+1], [x + 2, y+1], [x + 3, y+1], [x + 4, y+1], [x + 5, y+1], [x + 6, y+1],
                         [x, y+2], [x + 2, y+2], [x + 4, y+2], [x + 6, y+2],
                         [x, y+3], [x + 1, y+3], [x + 2, y+3], [x + 3, y+3], [x + 4, y+3], [x + 5, y+3], [x + 6, y+3],
                         [x + 1, y+4], [x + 3, y+4], [x + 5, y+4]
                         ];
               
        var enemyTankBoss = { baseDot: [x, y], positions: _position, MoveDirection:"left"};
        drawEnemyTank(enemyTankBoss);
        currentEnemyTankBoss=enemyTankBoss;
    }
    //返回一个敌方坦克（不添加到集合，改变方向）
    var getEnemyTank = function (x, y, d) {
        var _position = [];
        switch (d) {
            case "up":
                _position = [[x + 1, y], [x, y + 1], [x + 2, y + 1], [x + 1, y + 1], [x, y + 2], [x + 2, y + 2]];
                break;
            case "down":
                _position = [[x + 1, y + 2], [x + 2, y + 1], [x, y + 1], [x, y], [x + 2, y], [x + 1, y + 1]];
                break;
            case "left":
                _position = [[x, y + 1], [x + 1, y + 2], [x + 1, y], [x + 2, y], [x + 1, y + 1], [x + 2, y + 2]];
                break;
            case "right":
                _position = [[x + 2, y + 1], [x + 1, y], [x + 1, y + 2], [x, y], [x + 1, y + 1], [x, y + 2]];
                break;
        }
        var enemyTank = { baseDot: [x, y], positions: _position, direction: d };
        drawEnemyTank(enemyTank);
        return enemyTank;
    }
    //绘制一个我方坦克
    var drawMeTank = function (meTank,clearBoxs=[]) {
        if(clearBoxs.length==0)
        {
            for (var i = 0; i < meTank.positions.length; i++)
            { drawMeTankBox(meTank.positions[i][0], meTank.positions[i][1]); }
        }
        else
        {
            for (var i = 0; i < clearBoxs.length; i++)
           { drawMeTankBox(meTank.positions[clearBoxs[i]][0], meTank.positions[clearBoxs[i]][1]); }
        }       
    }
    //创建一个我方坦克
    var createMeTank = function (x, y, d) {
        var _position;
        switch (d) {
            case "up":
                _position = [[x + 1, y], [x, y + 1], [x + 2, y + 1], [x + 1, y + 1], [x, y + 2], [x + 2, y + 2]];
                break;
            case "down":
                _position = [[x + 1, y + 2], [x + 2, y + 1], [x, y + 1], [x + 1, y + 1], [x + 2, y], [x, y]];
                break;
            case "left":
                _position = [[x, y + 1], [x + 1, y + 2], [x + 1, y], [x + 1, y + 1], [x + 2, y + 2], [x + 2, y]];
                break;
            case "right":
                _position = [[x + 2, y + 1], [x + 1, y], [x + 1, y + 2],  [x + 1, y + 1], [x, y],[x, y + 2]];
                break;
        }
        var meTank = { baseDot: [x, y], positions: _position, direction: d };
        drawMeTank(meTank);
        currentMeTank = meTank;
    }
    //绘制一个敌方子弹
    var drawEnemyBullet = function (enemyBullet) {
        drawEnemyBulletBox(enemyBullet.position[0], enemyBullet.position[1]);
    }
    //创建一个敌方子弹
    var createEnemyBullet = function (x, y, d) {
        var enemyBullet = {origin:[x,y], position: [x, y], direction: d };
        drawEnemyBullet(enemyBullet);
        currentEnemyBullets.push(enemyBullet);
    }
    //绘制一个我方子弹
    var drawMeBullet = function (meBullet) {
        drawMeBulletBox(meBullet.position[0], meBullet.position[1]);
    }
    //创建一个我方子弹
    var createMeBullet = function (x, y, d) {
        if (currentMeBullets.length >= meBulletMaxCount) return;
        var meBullet = { origin: [x, y], position: [x, y], direction: d };
        drawMeBullet(meBullet);
        currentMeBullets.push(meBullet);
    }

    //清除一个单格
    var clearActBox = function (x, y) {
        if (x < 0 || y < 0) return;
        var i = y * bgCol + x;
        $(".box:eq(" + i + ")").css({ "width": boxSide - 1 + "px", "height": boxSide - 1 + "px", "background": "", "borderRight": "dashed 1px #1B272C", "borderBottom": "dashed 1px #1B272C", "borderLeft": "0px", "borderTop": "0px" });
        $(".box:eq(" + i + ")").attr("status", "null");
    }
    //清除一个坦克
    //clearBoxs:清除一个坦克中方格索引，例 [3,4,5]
    var clearTank = function (tank,clearBoxs=[]) {
        if(clearBoxs.length==0)
        {
            for (var i = 0; i < tank.positions.length; i++)
           { clearActBox(tank.positions[i][0], tank.positions[i][1]); }
        }
        else
        {
            for (var i = 0; i < clearBoxs.length; i++)
           { clearActBox(tank.positions[clearBoxs[i]][0], tank.positions[clearBoxs[i]][1]); }
        }
        
    }
    //清除一个子弹
    var clearBullet = function (bullet) {
        //如果是起始点，不清除
        if (bullet.position[0] == bullet.origin[0] && bullet.position[1] == bullet.origin[1]) return;
        //判断敌方子弹是否穿过敌方坦克
        var n = bullet.position[1] * bgCol + bullet.position[0];
        if ($(".box:eq(" + n + ")").attr("status") == "enemyBullet")
        {
            for (var j = 0; j < currentEnemyTanks.length; j++) {
                for (var k = 0; k < currentEnemyTanks[j].positions.length; k++) {
                    if (currentEnemyTanks[j].positions[k][0] == bullet.position[0] && currentEnemyTanks[j].positions[k][1] == bullet.position[1])
                    {
                        return;
                    }
                }
            }
        }
        clearActBox(bullet.position[0], bullet.position[1]);
    }
    //清除所有单格
    var clearAllBox = function () {
        $(".box").css({ "width": boxSide - 1 + "px", "height": boxSide - 1 + "px", "background": "", "borderRight": "dashed 1px #1B272C", "borderBottom": "dashed 1px #1B272C", "borderLeft": "0px", "borderTop": "0px" });
        $(".box").attr("status", "null");
    }


    //我方坦克移动一格
    var meTankMove = function () {
        if(isBossMode) return;
        switch (currentMeTank.direction) {
            case "up":
                if (currentMeTank.positions[0][1] - 1 < 0)
                    break;
                var n0 = (currentMeTank.positions[0][1] - 1) * bgCol + currentMeTank.positions[0][0];
                var n1 = (currentMeTank.positions[1][1] - 1) * bgCol + currentMeTank.positions[1][0];
                var n2 = (currentMeTank.positions[2][1] - 1) * bgCol + currentMeTank.positions[2][0];
                if ($(".box:eq(" + n0 + ")").attr("status") == "enemyTank"
                    || $(".box:eq(" + n1 + ")").attr("status") == "enemyTank"
                    || $(".box:eq(" + n2 + ")").attr("status") == "enemyTank") {
                    break;
                }
                clearTank(currentMeTank,[3,4,5]);
                for (var i = 0; i < currentMeTank.positions.length; i++) {
                    currentMeTank.positions[i][1] -= 1;
                }
                currentMeTank.baseDot[1] -= 1;
                drawMeTank(currentMeTank,[0,1,2]);
                break;
            case "down":       
                if (currentMeTank.positions[0][1] + 1 > bgRow - 1)
                    break;
                var n0 = (currentMeTank.positions[0][1] + 1) * bgCol + currentMeTank.positions[0][0];
                var n1 = (currentMeTank.positions[1][1] + 1) * bgCol + currentMeTank.positions[1][0];
                var n2 = (currentMeTank.positions[2][1] + 1) * bgCol + currentMeTank.positions[2][0];
                if ($(".box:eq(" + n0 + ")").attr("status") == "enemyTank"
                    || $(".box:eq(" + n1 + ")").attr("status") == "enemyTank"
                    || $(".box:eq(" + n2 + ")").attr("status") == "enemyTank") {
                    break;
                }
                clearTank(currentMeTank,[3,4,5]);
                for (var i = 0; i < currentMeTank.positions.length; i++) {
                    currentMeTank.positions[i][1] += 1;
                }
                currentMeTank.baseDot[1] += 1;
                drawMeTank(currentMeTank,[0,1,2]);
                break;
            case "left":
                if (currentMeTank.positions[0][0] - 1 < 0)
                    break;
                var n0 = currentMeTank.positions[0][1] * bgCol + currentMeTank.positions[0][0] - 1;
                var n1 = currentMeTank.positions[1][1] * bgCol + currentMeTank.positions[1][0] - 1;
                var n2 = currentMeTank.positions[2][1] * bgCol + currentMeTank.positions[2][0] - 1;
                if ($(".box:eq(" + n0 + ")").attr("status") == "enemyTank"
                    || $(".box:eq(" + n1 + ")").attr("status") == "enemyTank"
                    || $(".box:eq(" + n2 + ")").attr("status") == "enemyTank") {
                    break;
                }
                clearTank(currentMeTank,[3,4,5]);
                for (var i = 0; i < currentMeTank.positions.length; i++) {
                    currentMeTank.positions[i][0] -= 1;
                }
                currentMeTank.baseDot[0] -= 1;
                drawMeTank(currentMeTank,[0,1,2]);
                break;
            case "right":
                if (currentMeTank.positions[0][0] + 1 > bgCol - 1)
                    break;
                var n0 = currentMeTank.positions[0][1] * bgCol + currentMeTank.positions[0][0]+1;
                var n1 = currentMeTank.positions[1][1] * bgCol + currentMeTank.positions[1][0]+1;
                var n2 = currentMeTank.positions[2][1] * bgCol + currentMeTank.positions[2][0]+1;
                if ($(".box:eq(" + n0 + ")").attr("status") == "enemyTank"
                    || $(".box:eq(" + n1 + ")").attr("status") == "enemyTank"
                    || $(".box:eq(" + n2 + ")").attr("status") == "enemyTank") {
                    break;
                }
                clearTank(currentMeTank,[3,4,5]);
                for (var i = 0; i < currentMeTank.positions.length; i++) {
                    currentMeTank.positions[i][0] += 1;
                }
                currentMeTank.baseDot[0] += 1;
                drawMeTank(currentMeTank,[0,1,2]);
                break;
        }
    }
    //我方子弹移动一格
    var MeBulletMove = function () {
        for (var i = 0; i < currentMeBullets.length; i++) {
            switch (currentMeBullets[i].direction) {
                case "up":
                    clearBullet(currentMeBullets[i]);
                    currentMeBullets[i].position[1] -= 1;                      
                    if (currentMeBullets[i].position[1] < 0 ) {
                        currentMeBullets.splice(i, 1);
                        break;
                    }
                    doMeBulletMove(i);                      
                    break;
                case "down":
                    clearBullet(currentMeBullets[i]);
                    currentMeBullets[i].position[1] += 1;
                    if (currentMeBullets[i].position[1] > bgRow - 1) {
                        currentMeBullets.splice(i, 1);
                        break;
                    }
                    doMeBulletMove(i);
                    break;
                case "left":
                    clearBullet(currentMeBullets[i]);
                    currentMeBullets[i].position[0] -= 1;
                    if (currentMeBullets[i].position[0] < 0) {
                        currentMeBullets.splice(i, 1);
                        break;
                    }
                    doMeBulletMove(i);
                    break;
                case "right":
                    clearBullet(currentMeBullets[i]);
                    currentMeBullets[i].position[0] += 1;
                    if (currentMeBullets[i].position[0] > bgCol - 1) {
                        currentMeBullets.splice(i, 1);
                        break;
                    }
                    doMeBulletMove(i);
                    break;
            }
        }
    }
    //处理我方子弹移动过程
    var doMeBulletMove = function (i) {
        var n = currentMeBullets[i].position[1] * bgCol + currentMeBullets[i].position[0];
        if ($(".box:eq(" + n + ")").attr("status") == "enemyTank") {
            if(isBossMode){
                playAudio(audioCrash);                
                clearBullet(currentMeBullets[i]);
                currentMeBullets.splice(i, 1);

                bossCurrentHP-=1;
                $("#bossHP").html("BOSS生命值：<span style='font-size:25px;color:orange'>"+bossCurrentHP+"</span>");
                if(bossCurrentHP==0){
                    level++;
                    if (level > 10) {
                        gameVictory();
                        return;
                    }
                    $("#level span").html(level);
                    enemyTankCurrentSpeed = enemyTankInitSpeed - (level - 1) * 50;
                    clearInterval(enemyTankTimerId);
                    clearInterval(enemyBulletRateTimerId);
                    enemyTankTimerId = setInterval(enemyTankTimerEvent, enemyTankCurrentSpeed);
                    enemyBulletRateSpeed = enemyTankCurrentSpeed * 4;
                    enemyBulletRateTimerId = setInterval(enemyBulletRateTimerEvent, enemyBulletRateSpeed);
                                        
                    isBossMode=false;
                    Init();
                    $("#bossHP").css({display:"none"});
                }              
            }else{
                for (var j = 0; j < currentEnemyTanks.length; j++) {
                    for (var k = 0; k < currentEnemyTanks[j].positions.length; k++) {
                        if (currentEnemyTanks[j].positions[k][0] == currentMeBullets[i].position[0] && currentEnemyTanks[j].positions[k][1] == currentMeBullets[i].position[1]) {
                            playAudio(audioCrash);

                            clearTank(currentEnemyTanks[j]);
                            clearBullet(currentMeBullets[i]);
                            currentMeBullets.splice(i, 1);
                            currentEnemyTanks.splice(j, 1);

                            score += 100;
                            if (score % levelScore == 0) {
                                isBossMode=true;
                                Init();
                                $("#bossHP").css({display:"block"})    
                            }
                            $("#score span").html(score);
                            return;
                        }
                    }
                }
            }
            
        }else{
            drawMeBullet(currentMeBullets[i]);
        }
        
    }
    //我方坦克改变方向
    var meTankChangeDirection = function (direction) {        
        if(isBossMode){
            if(direction=="down") return;
            if(direction=="left"&&currentMeTank.baseDot[0]==0) return;
            if(direction=="right"&&currentMeTank.baseDot[0]+2==bgCol-1) return;
            clearTank(currentMeTank);
            createMeTank(currentMeTank.baseDot[0] + (direction=="left"?-1:1), currentMeTank.baseDot[1], "up");
        }else{
            clearTank(currentMeTank);
            createMeTank(currentMeTank.baseDot[0], currentMeTank.baseDot[1], direction);
        }
        
    }
    //敌方坦克移动一格
    var enemyTankMove = function () {
        for (var i = 0; i < currentEnemyTanks.length; i++) {
            var flag = true;
            var objects = ["enemyTank", "meTank"];
            switch (currentEnemyTanks[i].direction) {
                case "up":
                    if (currentEnemyTanks[i].positions[0][1] - 1 <0) {
                        enemyTankChangeDirection(currentEnemyTanks[i], i, direction[randNum(4)]);
                        break;
                    }
                    var n0 = (currentEnemyTanks[i].positions[0][1] - 1) * bgCol + currentEnemyTanks[i].positions[0][0];
                    var n1 = (currentEnemyTanks[i].positions[1][1] - 1) * bgCol + currentEnemyTanks[i].positions[1][0];
                    var n2 = (currentEnemyTanks[i].positions[2][1] - 1) * bgCol + currentEnemyTanks[i].positions[2][0];
                    
                    for (var j = 0; j < objects.length; j++) {
                        if ($(".box:eq(" + n0 + ")").attr("status") == objects[j]
                            || $(".box:eq(" + n1 + ")").attr("status") == objects[j]
                            || $(".box:eq(" + n2 + ")").attr("status") == objects[j]) {
                            enemyTankChangeDirection(currentEnemyTanks[i], i, direction[randNum(4)]);
                            flag = false; break;
                        }
                    }
                    if (!flag) break;
                    clearTank(currentEnemyTanks[i],[3,4,5]);
                    for (var j = 0; j < currentEnemyTanks[i].positions.length; j++) {
                        currentEnemyTanks[i].positions[j][1] -= 1;
                    }
                    currentEnemyTanks[i].baseDot[1] -= 1;
                    drawEnemyTank(currentEnemyTanks[i],[0,1,2]);
                    break;
                case "down":
                    if (currentEnemyTanks[i].positions[0][1] + 1 > bgRow - 1)
                    {
                        enemyTankChangeDirection(currentEnemyTanks[i], i, direction[randNum(4)]);
                        break;
                    }
                    var n0=(currentEnemyTanks[i].positions[0][1] + 1) * bgCol + currentEnemyTanks[i].positions[0][0];
                    var n1=(currentEnemyTanks[i].positions[1][1] + 1) * bgCol + currentEnemyTanks[i].positions[1][0];
                    var n2 = (currentEnemyTanks[i].positions[2][1] + 1) * bgCol + currentEnemyTanks[i].positions[2][0];
                    for (var j = 0; j < objects.length; j++) {
                        if ($(".box:eq(" + n0 + ")").attr("status") == objects[j]
                            || $(".box:eq(" + n1 + ")").attr("status") == objects[j]
                            || $(".box:eq(" + n2 + ")").attr("status") == objects[j]) {
                            enemyTankChangeDirection(currentEnemyTanks[i], i, direction[randNum(4)]);
                            flag = false; break;
                        }
                    }
                    if (!flag) break;
                    clearTank(currentEnemyTanks[i],[3,4,5]);
                    for (var j = 0; j < currentEnemyTanks[i].positions.length; j++) {
                        currentEnemyTanks[i].positions[j][1] += 1;
                    }
                    currentEnemyTanks[i].baseDot[1] += 1;
                    drawEnemyTank(currentEnemyTanks[i],[0,1,2]);
                    break;
                case "left":
                    if (currentEnemyTanks[i].positions[0][0] - 1 <0) {
                        enemyTankChangeDirection(currentEnemyTanks[i], i, direction[randNum(4)]);
                        break;
                    }
                    var n0 = currentEnemyTanks[i].positions[0][1] * bgCol + currentEnemyTanks[i].positions[0][0]- 1;
                    var n1 = currentEnemyTanks[i].positions[1][1] * bgCol + currentEnemyTanks[i].positions[1][0]- 1;
                    var n2 = currentEnemyTanks[i].positions[2][1] * bgCol + currentEnemyTanks[i].positions[2][0]- 1;
                    for (var j = 0; j < objects.length; j++) {
                        if ($(".box:eq(" + n0 + ")").attr("status") == objects[j]
                            || $(".box:eq(" + n1 + ")").attr("status") == objects[j]
                            || $(".box:eq(" + n2 + ")").attr("status") == objects[j]) {
                            enemyTankChangeDirection(currentEnemyTanks[i], i, direction[randNum(4)]);
                            flag = false; break;
                        }
                    }
                    if (!flag) break;
                    clearTank(currentEnemyTanks[i],[3,4,5]);
                    for (var j = 0; j < currentEnemyTanks[i].positions.length; j++) {
                        currentEnemyTanks[i].positions[j][0] -= 1;
                    }
                    currentEnemyTanks[i].baseDot[0] -= 1;
                    drawEnemyTank(currentEnemyTanks[i],[0,1,2]);
                    break;
                case "right":
                    if (currentEnemyTanks[i].positions[0][0] + 1 > bgCol-1) {
                        enemyTankChangeDirection(currentEnemyTanks[i], i, direction[randNum(4)]);
                        break;
                    }
                    var n0 = currentEnemyTanks[i].positions[0][1] * bgCol + currentEnemyTanks[i].positions[0][0]+1;
                    var n1 = currentEnemyTanks[i].positions[1][1] * bgCol + currentEnemyTanks[i].positions[1][0]+1;
                    var n2 = currentEnemyTanks[i].positions[2][1] * bgCol + currentEnemyTanks[i].positions[2][0]+1;
                    for (var j = 0; j < objects.length; j++) {
                        if ($(".box:eq(" + n0 + ")").attr("status") == objects[j]
                            || $(".box:eq(" + n1 + ")").attr("status") == objects[j]
                            || $(".box:eq(" + n2 + ")").attr("status") == objects[j]) {
                            enemyTankChangeDirection(currentEnemyTanks[i], i, direction[randNum(4)]);
                            flag = false; break;
                        }
                    }
                    if (!flag) break;
                    clearTank(currentEnemyTanks[i],[3,4,5]);
                    for (var j = 0; j < currentEnemyTanks[i].positions.length; j++) {
                        currentEnemyTanks[i].positions[j][0] += 1;
                    }
                    currentEnemyTanks[i].baseDot[0] += 1;
                    drawEnemyTank(currentEnemyTanks[i],[0,1,2]);
                    break;
            }
        }
    }
    //敌方坦克Boss移动一格
    var enemyTankBossMove = function () {
        if(currentEnemyTankBoss.MoveDirection=="left"){
            if(currentEnemyTankBoss.positions[0][0]-1<0)
            {
                currentEnemyTankBoss.MoveDirection="right"
                return;
            }
            else
            {
                clearTank(currentEnemyTankBoss);
                for (var j = 0; j < currentEnemyTankBoss.positions.length; j++) {
                        currentEnemyTankBoss.positions[j][0] -= 1;
                }
                currentEnemyTankBoss.baseDot[0] -= 1;
                drawEnemyTank(currentEnemyTankBoss);
            }
        }else{
            if(currentEnemyTankBoss.positions[3][0]+1>bgCol-1)
            {
                currentEnemyTankBoss.MoveDirection="left"
                return;
            }
            else
            {
                clearTank(currentEnemyTankBoss);
                for (var j = 0; j < currentEnemyTankBoss.positions.length; j++) {
                        currentEnemyTankBoss.positions[j][0] += 1;
                }
                currentEnemyTankBoss.baseDot[0] += 1;
                drawEnemyTank(currentEnemyTankBoss);
            }
        }
    }
    //敌方子弹移动一格
    var EnemyBulletMove = function () {
        for (var i = 0; i < currentEnemyBullets.length; i++) {
            switch (currentEnemyBullets[i].direction) {
                case "up":
                    clearBullet(currentEnemyBullets[i]);
                    currentEnemyBullets[i].position[1] -= 1;                
                    if (currentEnemyBullets[i].position[1] < 0) {
                        currentEnemyBullets.splice(i, 1);
                        break;
                    }
                    doEnemyBulletMove(i);
                    break;
                case "down":
                    clearBullet(currentEnemyBullets[i]);
                    currentEnemyBullets[i].position[1] += 1;
                    if (currentEnemyBullets[i].position[1] > bgRow - 1) {
                        currentEnemyBullets.splice(i, 1);
                        break;
                    }
                    doEnemyBulletMove(i);
                    break;
                case "left":
                    clearBullet(currentEnemyBullets[i]);
                    currentEnemyBullets[i].position[0] -= 1;
                    if (currentEnemyBullets[i].position[0] < 0) {
                        currentEnemyBullets.splice(i, 1);
                        break;
                    }
                    doEnemyBulletMove(i);
                    break;
                case "right":
                    clearBullet(currentEnemyBullets[i]);
                    currentEnemyBullets[i].position[0] += 1; 
                    if (currentEnemyBullets[i].position[0] > bgCol - 1) {
                        currentEnemyBullets.splice(i, 1);
                        break;
                    }
                    doEnemyBulletMove(i);
                    break;
            }
        }
        // $("#score span").html(currentEnemyBullets.length);
    }
    //处理敌方子弹移动过程
    var doEnemyBulletMove=function(i){
        var n = currentEnemyBullets[i].position[1] * bgCol + currentEnemyBullets[i].position[0];
        if ($(".box:eq(" + n + ")").attr("status") == "meTank") {
            gameOver();
        } else {
            drawEnemyBullet(currentEnemyBullets[i]);
        }
    }
    //敌方坦克改变方向
    var enemyTankChangeDirection = function (enemyTank, i, direction) {
        clearTank(enemyTank);
        currentEnemyTanks.splice(i, 1, getEnemyTank(enemyTank.baseDot[0], enemyTank.baseDot[1], direction));
    }


    //创建一个小于指定值的随机整数
    var randNum = function (n) {
        return Math.floor(Math.random() * n);
    }
    //显示消息
    var showMsg = function (m) {
        var left=($("#frame").width()-400)/2;
        var top=($("#frame").height()-90)/2;
        $("#msg").html(m).css({"left":left+"px","top":top+"px","display":"block"}).animate({ "width": "400px", "height": "90px" }, 400);
    }
    //初始化
    var Init = function () {
        //背景图像调整后的大小
        bgImgSize = boxSide * 7 + "px " + boxSide * 5 + "px";
        //背景图像一组X,Y坐标值
        bgImgPositionXs = [0, -boxSide, -boxSide * 2, -boxSide * 3, -boxSide * 4, -boxSide * 5, -boxSide * 6];
        bgImgPositionYs = [0, -boxSide, -boxSide * 2, -boxSide * 3, -boxSide * 4];
        //我方坦克背景图像XY坐标值
        meBgPositionX = bgImgPositionXs[4];
        meBgPositionY = bgImgPositionYs[3];
        //敌方坦克背景图像XY坐标值
        enemyBgPositionX = bgImgPositionXs[0];
        enemyBgPositionY = bgImgPositionYs[3];
        //我方初始位置
        mePositions = [Math.floor(bgCol / 2) - 1, bgRow - 3];
        //敌方初始位置
        enemyPositions = [[0, 0], [Math.floor(bgCol / 2) - 1, 0], [bgCol - 3, 0]];
        //敌方Boss初始位置
        enemyBossPositions = [Math.floor(bgCol / 2) - 3, 0];
        //当前所有敌人坦克对象
        currentEnemyTanks = [];
        //当前所有敌方子弹对象
        currentEnemyBullets = [];
        //当前我方子弹对象
        currentMeBullets = [];

        bossCurrentHP=bossHP+level;
        $("#bossHP").html("BOSS生命值：<span style='font-size:25px;color:orange'>"+bossCurrentHP+"</span>");
        //敌方移动速度初始化
        enemyTankCurrentSpeed=enemyTankInitSpeed - (level - 1) * 50;
        //敌方子弹发射频率初始化
        enemyBulletRateSpeed = enemyTankCurrentSpeed * 4;
        //清空box元素
        $("#main").empty();
        //加载背景网格
        for (var i = 0; i < bgCol * bgRow; i++) {
            var box = $("<div class='box' status='null'></div>");
            $("#main").append(box);
        }
        $(".box").css({"float":"left", "width": boxSide - 1 + "px", "height": boxSide - 1 + "px", "borderRight": "dashed 1px #1B272C", "borderBottom": "dashed 1px #1B272C", "borderLeft": "0px", "borderTop": "0px" });
        $("#bodyleft").css("width", bgCol * boxSide + "px");
        $("#framebody").css("height", bgRow * boxSide + "px");
        $("#frame").css({ "width": bgCol * boxSide + 82 + "px", "height": bgRow * boxSide + 22 + "px" });

        createMeTank(mePositions[0], mePositions[1], "up");
        if(isBossMode){
            createEnemyTankBoss(enemyBossPositions[0],enemyBossPositions[1]);
        }else{
            createEnemyTank(enemyPositions[0][0], enemyPositions[0][1],direction[randNum(4)]);
            createEnemyTank(enemyPositions[1][0], enemyPositions[1][1], direction[randNum(4)]);
            createEnemyTank(enemyPositions[2][0], enemyPositions[2][1], direction[randNum(4)]);
        }    
    }
    //游戏结束
    var gameOver = function () {
        runing = false;
        clearInterval(meBulletTimerId);
        clearInterval(enemyBulletTimerId);
        clearInterval(enemyTankTimerId);
        clearInterval(enemyBulletRateTimerId);
        $("#btnControl").val("开始");
        $("#btnSetting,#btnControl").attr("disabled","disabled").css("backgroundColor","rgba(204, 204, 204, 0.34)");
        showMsg("很遗憾你中弹了！");
    }
    //游戏胜利
    var gameVictory = function () {
        runing = false;
        clearInterval(meBulletTimerId);
        clearInterval(enemyBulletTimerId);
        clearInterval(enemyTankTimerId);
        clearInterval(enemyBulletRateTimerId);
        $("#btnControl").val("开始");
        $("#btnSetting,#btnControl").attr("disabled","disabled").css("backgroundColor","rgba(204, 204, 204, 0.34)");
        showMsg("恭喜你通关了！");
    }
    //控制方向
    var isKeyDown = false;
    $(document).keydown(function (e) {
        if (runing) {
            if (isKeyDown) return;
            isKeyDown = true;
            var key = e.which;
            switch (key) {
                case 37: currentMeTank.direction == "left" ? meTankMove() : meTankChangeDirection("left"); break;
                case 38: currentMeTank.direction == "up" ? meTankMove() : meTankChangeDirection("up"); break;
                case 39: currentMeTank.direction == "right" ? meTankMove() : meTankChangeDirection("right"); break;
                case 40: currentMeTank.direction == "down" ? meTankMove() : meTankChangeDirection("down"); break;
                case 90: createMeBullet(currentMeTank.positions[0][0], currentMeTank.positions[0][1], currentMeTank.direction); break;
                case 34: createMeBullet(currentMeTank.positions[0][0], currentMeTank.positions[0][1], currentMeTank.direction); break;
            }
			setTimeout("isKeyDown=false",meTankSpeed);
        }
    });
    //我方子弹计时器事件
    var meBulletTimerEvent = function () {
        MeBulletMove();
    }
    //敌方子弹计时器事件
    var enemyBulletTimerEvent = function () {
        EnemyBulletMove();
    }
    //敌方坦克计时器事件
    var enemyTankTimerEvent = function () {
       isBossMode? enemyTankBossMove() : enemyTankMove();
    }
    //敌方坦克子弹发射频率事件
    var enemyBulletRateTimerEvent = function () {
        if(isBossMode){
            if(randNum(2)) createEnemyBullet(currentEnemyTankBoss.positions[22][0], currentEnemyTankBoss.positions[22][1], "down");
            if(randNum(2)) createEnemyBullet(currentEnemyTankBoss.positions[23][0], currentEnemyTankBoss.positions[23][1], "down");
            if(randNum(2)) createEnemyBullet(currentEnemyTankBoss.positions[24][0], currentEnemyTankBoss.positions[24][1], "down");           
        }else{
            for (var i = 0; i < currentEnemyTanks.length; i++) {
                if(randNum(2))
                    createEnemyBullet(currentEnemyTanks[i].positions[0][0], currentEnemyTanks[i].positions[0][1], currentEnemyTanks[i].direction);
            }
            if (currentEnemyTanks.length < enemyTankMaxCount)
            {
                var r = randNum(3);
                createEnemyTank(enemyPositions[r][0], enemyPositions[r][1], direction[randNum(4)]);
            }
        }           
    }
    //加载事件
    $(function () {
        var c = document.getElementById("myCanvas");
        cxt = c.getContext("2d");
        cxt.strokeStyle = "#ccc";
        musicOpen();
        //声音控制
        $("#myCanvas").click(function () { musicStatus ? musicClose() : musicOpen(); });
       
        //开始按钮
        $("#btnControl").click(function () {
            if ($(this).val() == "开始") {
                runing = true;
                meBulletTimerId = setInterval(meBulletTimerEvent, meBulletSpeed);
                enemyBulletTimerId = setInterval(enemyBulletTimerEvent, enemyBulletSpeed);
                enemyTankTimerId = setInterval(enemyTankTimerEvent, enemyTankCurrentSpeed);
                enemyBulletRateTimerId = setInterval(enemyBulletRateTimerEvent, enemyBulletRateSpeed);
                $(this).val("暂停");
                $("#setLevel").attr("disabled","disabled").parent().css("color","gray");
            }
            else {
                runing = false;
                clearInterval(meBulletTimerId);
                clearInterval(enemyBulletTimerId);
                clearInterval(enemyTankTimerId);
                clearInterval(enemyBulletRateTimerId);
                $(this).val("开始");
            }
        });
        //设置
        $("#btnSetting").click(function(){
            $("#boxWidth").val(boxSide).next().val(boxSide);
            $("#mainWidth").val(bgCol).next().val(bgCol);
            $("#mainHeight").val(bgRow).next().val(bgRow);
            $("#setLevel").val(level).next().val(level);
            
            var left=($("#frame").width()-$("#divSetting").width())/2;
            var top=($("#frame").height()-$("#divSetting").height())/2;
            $("#divSetting").css({"left":left+"px","top":top+"px","display":"block"})
        });
        $("input[type='range']").change(function(){
            $(this).next().val(this.value);
        });
        //保存
        $("#btnSave").click(function(){
            boxSide=$("#boxWidth").val();
            bgCol=$("#mainWidth").val();
            bgRow=$("#mainHeight").val();
            if(!$("#setLevel").attr("disabled")){
                level=parseInt($("#setLevel").val());
                $("#level span").html(level);
            }
            Init();
        });
        //关闭
        $("#btnClose").click(function(){
            $("#divSetting").css("display","none");
        });
        Init();
});
</script>
</body>
</html>